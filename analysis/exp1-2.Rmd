---
title: "Analyze exps: 1 and 2 (intial testing of parkid)"
output: html_notebook
---

# Library
```{r, message=FALSE}
library(zoo)
library(ggplot2)
library(ggpubr)
library(patchwork)
library(tidyr)
library(dplyr)
library(gridExtra)
library(grid)
library(readr)
library(latex2exp)
# library(MASS) 
library(scales)
library(patchwork)
options(scipen=1000000)

# Load load_result and other helpful functions
source("utils.R")

# --- Main path to all data ---
data_path <- "~/Code/parkid/data/"
```

# Fig. Exploration 
## Load data (task 1)
```{r, message=FALSE}
# -------------------------------------------------------------
# User def
task_name <- "change_bandits"
num_episodes <- 1210 * 4
run_codes <- 1:10
num_arms <- 121

run_codes <- 1:10
exp_names <- c("exp1", "exp2")
agent_names <- c("Parkid", "Par")
file_names <- c("par_action", "par_policy", "kid_action", "kid_policy", "total_R", "total_G")

# Init
E_bias <- log(num_arms) * num_arms 

# !
results <- NULL
for(i in 1:length(exp_names)){
  exp_name <- exp_names[i]
  agent_name <- agent_names[i]

  tmp <- load_result(exp_name, run_codes, file_names, 
                     n_max=num_episodes+1)
  
  tmp %>% 
    filter(global_step <= num_episodes) -> tmp
  tmp$exp <- exp_name
  tmp$agent <- agent_name
  tmp$task <- task_name
  tmp$num_episodes <- num_episodes
  
  results <- bind_rows(results, tmp)
}

# clean
rm(tmp, agent_names, agent_name, E_bias, exp_name, exp_names, file_names, i)
```

# Rewards
```{r, fig.width=1, fig.height=1}
results %>% 
  group_by(agent, run) %>% 
  summarise(total_R=last(total_R),
            total_G=last(total_G)) -> tmp

tmp %>% 
  ggplot(aes(x=agent, y=total_R/num_episodes)) +
  geom_jitter(width=0.1) +
  theme_classic2() +
  labs(x="", y="Reward")
```
# Actions
## Exp 1
```{r, fig.width=4, fig.height=4}
results %>% 
  filter(exp == "exp1") %>% 
  ggplot(aes(x=global_step, y=par_action, color=factor(par_policy))) +
  geom_point() +
  facet_wrap(run~.) +
  theme_classic2() +
  theme(
    strip.background = element_blank(),
    strip.text.x = element_blank()
  ) +
  scale_colour_manual("Policy", values=c("orchid4", "grey1")) +
  labs(x="Episode", y="Choice", title="Par") -> p1

results %>% 
  filter(exp == "exp1") %>% 
  ggplot(aes(x=global_step, y=kid_action, color=factor(kid_policy))) +
  geom_point() +
  facet_wrap(run~.) +
  theme_classic2() +
  theme(
    strip.background = element_blank(),
    strip.text.x = element_blank()
  ) +
  scale_colour_manual("Policy", values=c("orchid4", "grey1")) +
  labs(x="Episode", y="Choice", title="Kid") -> p2

p1 / p2
```

## Exp 1 v 2
```{r, fig.width=4, fig.height=4}
results %>% 
  filter(exp == "exp1") %>% 
  ggplot(aes(x=global_step, y=par_action, color=factor(par_policy))) +
  geom_point() +
  facet_wrap(run~.) +
  theme_classic2() +
  theme(
    strip.background = element_blank(),
    strip.text.x = element_blank()
  ) +
  scale_colour_manual("Policy", values=c("orchid4", "grey1")) +
  lims(x=c(1, num_episodes)) +
  labs(x="Episode", y="Choice", title="Exp 1 - par") -> p1

results %>% 
  filter(exp == "exp2") %>% 
  ggplot(aes(x=global_step, y=par_action, color=factor(par_policy))) +
  geom_point() +
  facet_wrap(run~.) +
  theme_classic2() +
  theme(
    strip.background = element_blank(),
    strip.text.x = element_blank()
  ) +
  scale_colour_manual("Policy", values=c("orchid4", "grey1")) +
  labs(x="Episode", y="Choice", title="Exp 2 - par") -> p2

p1 / p2
```
